{% extends "writeup_layout.html" %}

{% block main_content %}

<div class="challenge_desc">
    <h2>
        Hack The Box: Bastion
    </h2>
            
    <h3>
        Difficulty: Easy<br>
        Platform: Windows<br>
        Points: 20<br>
    </h3>
</div>

<p>
    The IP of this box is 10.10.10.134. so let's start off by running an nmap on it.
</p>

<div class="code"><pre>
Nmap report: nmap -sC -sV -oA bastion_scan 10.10.10.134
    
# Nmap 7.70 scan initiated Mon Jun 17 02:11:59 2019 as: nmap -sC -sV -oA bastion_scan 10.10.10.134
Nmap scan report for 10.10.10.134
Host is up (0.035s latency).
Not shown: 996 closed ports
PORT    STATE SERVICE      VERSION
22/tcp  open  ssh          OpenSSH for_Windows_7.9 (protocol 2.0)
| ssh-hostkey: 
|   2048 3a:56:ae:75:3c:78:0e:c8:56:4d:cb:1c:22:bf:45:8a (RSA)
|   256 cc:2e:56:ab:19:97:d5:bb:03:fb:82:cd:63:da:68:01 (ECDSA)
|_  256 93:5f:5d:aa:ca:9f:53:e7:f2:82:e6:64:a8:a3:a0:18 (ED25519)
135/tcp open  msrpc        Microsoft Windows RPC
139/tcp open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: -39m38s, deviation: 1h09m14s, median: 19s
| smb-os-discovery: 
|   OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3)
|   Computer name: Bastion
|   NetBIOS computer name: BASTION\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2019-06-17T08:12:32+02:00
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2019-06-17 02:12:33
|_  start_date: 2019-06-16 18:00:13

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Mon Jun 17 02:12:20 2019 -- 1 IP address (1 host up) scanned in 21.49 seconds
</pre>
</div>

<p>
    This machine is not running  website. That is pretty unusual for HackTheBox. However, it's a great opportunity to learn by poking at other services. 
    The most likely candidate to be our path forward is SMB, so I will start there with SMBmap.
</p>

<div class="code">
    <pre>
root@kali:~/vm_share/HackTheBox/Bastion-134# smbmap -H 10.10.10.134 -u Guest
[+] Finding open SMB ports....
[+] User SMB session establishd on 10.10.10.134...
[+] IP: 10.10.10.134:445	Name: 10.10.10.134                                      
Disk                                                  	Permissions
----                                                  	-----------
ADMIN$                                            	NO ACCESS
Backups                                           	READ, WRITE
C$                                                	NO ACCESS
IPC$                                              	READ ONLY
</pre>
</div>

    <p>
        It is worth noting that a username must be supplied to smbmap or this will fail with an authentication error. I used "Guest", but any username will do.<br>
        Here we see a few shares listed. We have no access to C$, and IPC$ won't get us anywhere, but there is an interesting non-default "Backups" share. Poking at that a bit 
        deeper with smbclient, we can see there is some stuff in here that may be of use. 
    </p>

    <div class="code">
        <pre>
root@kali:~/vm_share/HackTheBox/Bastion-134# smbclient \\\\10.10.10.134\\Backups
Enter WORKGROUP\root's password: 
Try "help" to get a list of possible commands.
smb: \> ls
.                                   D        0  Mon Aug  5 14:33:24 2019
..                                  D        0  Mon Aug  5 14:33:24 2019
note.txt                           AR      116  Tue Apr 16 06:10:09 2019
WindowsImageBackup                  D        0  Fri Feb 22 07:44:02 2019
                
    7735807 blocks of size 4096. 2791963 blocks available
smb: \> 
        </pre>
    </div>

    <p>
        Here, note that the password field is left blank. In the root of the share, we see an interesting folder named "WindowsImageBackup" and a cryptic note.txt.
        The contents of the note is "Sysadmins: please don't transfer the entire backup file locally, the VPN to the subsidiary office is too slow".
        I heard people whining on Discord about how slow this box is, and it's probably because some assholes can't read. That backup we saw earlier is 
        probably freaking huge and will choke the whole box if we download it. Let's see what's in there, since this is clearly the route we're supposed 
        to take if the note is giving a warning like this.
    </p>

    <div class="code">
        <pre>
root@kali:~/vm_share/HackTheBox/Bastion-134# smbclient \\\\10.10.10.134\\Backups
Enter WORKGROUP\root's password: 
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Tue Apr 16 06:02:11 2019
  ..                                  D        0  Tue Apr 16 06:02:11 2019
  note.txt                           AR      116  Tue Apr 16 06:10:09 2019
  WindowsImageBackup                  D        0  Fri Feb 22 07:44:02 2019

		7735807 blocks of size 4096. 2778858 blocks available
smb: \> cd WindowsImageBackup\
smb: \WindowsImageBackup\> ls
  .                                   D        0  Fri Feb 22 07:44:02 2019
  ..                                  D        0  Fri Feb 22 07:44:02 2019
  L4mpje-PC                           D        0  Fri Feb 22 07:45:32 2019

		7735807 blocks of size 4096. 2778803 blocks available
smb: \WindowsImageBackup\> cd L4mpje-PC\
smb: \WindowsImageBackup\L4mpje-PC\> ls
  .                                   D        0  Fri Feb 22 07:45:32 2019
  ..                                  D        0  Fri Feb 22 07:45:32 2019
  Backup 2019-02-22 124351            D        0  Fri Feb 22 07:45:32 2019
  Catalog                             D        0  Fri Feb 22 07:45:32 2019
  MediaId                             A       16  Fri Feb 22 07:44:02 2019
  SPPMetadataCache                    D        0  Fri Feb 22 07:45:32 2019

		7735807 blocks of size 4096. 2778803 blocks available
smb: \WindowsImageBackup\L4mpje-PC\> cd Backup 2019-02-22 124351\
cd \WindowsImageBackup\L4mpje-PC\Backup\: NT_STATUS_OBJECT_NAME_NOT_FOUND
smb: \WindowsImageBackup\L4mpje-PC\> cd "Backup 2019-02-22 124351"
smb: \WindowsImageBackup\L4mpje-PC\Backup 2019-02-22 124351\> ls
  .                                   D        0  Fri Feb 22 07:45:32 2019
  ..                                  D        0  Fri Feb 22 07:45:32 2019
  9b9cfbc3-369e-11e9-a17c-806e6f6e6963.vhd      A 37761024  Fri Feb 22 07:44:03 2019
  9b9cfbc4-369e-11e9-a17c-806e6f6e6963.vhd      A 5418299392  Fri Feb 22 07:45:32 2019
  BackupSpecs.xml                     A     1186  Fri Feb 22 07:45:32 2019
  cd113385-65ff-4ea2-8ced-5630f6feca8f_AdditionalFilesc3b9f3c7-5e52-4d5e-8b20-19adc95a34c7.xml      A     1078  Fri Feb 22 07:45:32 2019
  cd113385-65ff-4ea2-8ced-5630f6feca8f_Components.xml      A     8930  Fri Feb 22 07:45:32 2019
  cd113385-65ff-4ea2-8ced-5630f6feca8f_RegistryExcludes.xml      A     6542  Fri Feb 22 07:45:32 2019
  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writer4dc3bdd4-ab48-4d07-adb0-3bee2926fd7f.xml      A     2894  Fri Feb 22 07:45:32 2019
  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writer542da469-d3e1-473c-9f4f-7847f01fc64f.xml      A     1488  Fri Feb 22 07:45:32 2019
  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writera6ad56c2-b509-4e6c-bb19-49d8f43532f0.xml      A     1484  Fri Feb 22 07:45:32 2019
  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writerafbab4a2-367d-4d15-a586-71dbb18f8485.xml      A     3844  Fri Feb 22 07:45:32 2019
  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writerbe000cbe-11fe-4426-9c58-531aa6355fc4.xml      A     3988  Fri Feb 22 07:45:32 2019
  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writercd3f2362-8bef-46c7-9181-d62844cdc0b2.xml      A     7110  Fri Feb 22 07:45:32 2019
  cd113385-65ff-4ea2-8ced-5630f6feca8f_Writere8132975-6f93-4464-a53e-1050253ae220.xml      A  2374620  Fri Feb 22 07:45:32 2019

		7735807 blocks of size 4096. 2778803 blocks available
smb: \WindowsImageBackup\L4mpje-PC\Backup 2019-02-22 124351\> 
        </pre>
    </div>

    <p>
        Pay attention to quotes in paths with spaces in them. SMBclient's tab completion is not friendly with these. <br>
        Now we see two VHD files, along with a bunch of xml that isn't too interesting. A VHD file is a virtual hard disk, 
        so what we re looking at there is probably the entire hard drive of the target machine. Sweet!
        Fortunately, I had just watched an awesome video by 13cubed on how to mount VHD files, have a watch <a href="https://www.youtube.com/watch?v=A7OlFwTNWYc">here</a>.<br>
        Now we get to have some fun mounting stuff. First off, smbclient ain't going to cut it no more, we need cifs-utils. 
        I made a folder named "mount" and mounted the Backups share with the following.
    </p>

    <div class="code">
        <pre>
root@kali:~/vm_share/HackTheBox/Bastion-134# mount -t cifs,cifs //10.10.10.134/Backups mount/
Password for root@//10.10.10.134/Backups:  
root@kali:~/vm_share/HackTheBox/Bastion-134# ls mount/
note.txt  WindowsImageBackup
root@kali:~/vm_share/HackTheBox/Bastion-134#
        </pre>
    </div>

    <p>
            Next, I create a folder named vhd_mount, and mount the larger of the two VHD files with the following.
    </p>

    <div class="code">
<pre>
root@kali:~/vm_share/HackTheBox/Bastion-134# guestmount -a mount/WindowsImageBackup/L4mpje-PC/Backup\ 2019-02-22\ 124351/9b9cfbc4-369e-11e9-a17c-806e6f6e6963.vhd\\
 -m /dev/sda1 -r vhd_mount -o allow_other
root@kali:~/vm_share/HackTheBox/Bastion-134# cd vhd_mount
root@kali:~/vm_share/HackTheBox/Bastion-134/vhd_mount# ls
'$Recycle.Bin'   autoexec.bat   config.sys  'Documents and Settings'   pagefile.sys   PerfLogs   
ProgramData  'Program Files'   Recovery  'System Volume Information'   Users   Windows
root@kali:~/vm_share/HackTheBox/Bastion-134/vhd_mount# 
</pre>
    </div>
</div>


{% endblock %}